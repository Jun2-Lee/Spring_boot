# 웹 서버, 웹 애플리케이션 서버

웹은 HTTP를 기반으로 통신을 하게 된다. HTTP 메세지 안에 모든 것을 전송한다.

## 웹 서버(Web Server)
- HTTP 기반으로 동작
- 정적 리소스 제공, 기타 부가기능
- 정적 HTML, CSS, JS, 이미지, 영상

## 웹 애플리케이션 서버(WAS - Web Application Server)
- HTTP 기반으로 동작
- 웹 서버기능 포함
- 프로그램 코드를 실행해서 애플리케이션 로직 수행
- 동적 HTML, HTTP API, 서블릿, JSP, 스프링 MVC

### 웹 서버, 웹 애플리케이션 서버의 차이
- 웹 서버는 정적 리소스, WAS는 애플리케이션 로직
- 하지만 둘의 용어도 경계도 모호함

### 웹 시스템 구성 - WAS,DB
- WAS, DB만으로 시스템을 구성할 수 있다
- WAS는 정적 리소스, 애플리케이션 로직 모두 제공 가능
- 하지만 WAS가 너무 많은 역할을 담당하고, 서버 과부하의 위험이 있다
- WAS 장애 발생시 오류 화면도 노출이 불가능하다
<img width="800" alt="스크린샷 2022-02-15 오후 9 29 58" src="https://user-images.githubusercontent.com/80378041/154062436-e6e64f1e-c867-42f3-bf5f-3602545be7e1.png">

### 웹 시스템 구성 - WEB, WAS,DB
- 정적 리소스는 웹 서버가 처리
- 웹 서버는 애플리케이션 로직같은 동적 처리가 필요할 때 WAS에 요청을 위임
- WAS는 중요한 애플리케이션 로직 처리를 전담
- 정적 리소스만 제공하는 웹 서버는 잘 죽지 않음
- WAS, DB에 장애 발생시 WEB 서버가 오류 화면을 제공할 수 있다
<img width="1014" alt="스크린샷 2022-02-15 오후 9 30 14" src="https://user-images.githubusercontent.com/80378041/154062448-419fb046-93d4-4a23-9a42-edab8221d99f.png">

## 서블릿
 
HTTP의 요청 및 응답 정보를 편하게 사용할 수 있도록 만들어주는 툴이다
 
### HTTP 요청, 응답 흐름
- HTTP 요청시
 - WAS는 Request, Response 객체를 새로 만들어서 서블릿 객체 호출
 - 개발자는 Request 객체에서 HTTP 요청 정보를 편리하게 꺼내서 사용
 - 개발자는 Response 객체에 HTTP 응답 정보를 편리하게 입력
 - WAS는 Reponse 객체에 담겨있는 내용으로 HTTP 응답 정보를 생성

### 서블릿 컨테이너
- 톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 함
- 서블릿 컨테이너는 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기 관리
- 서블릿 객체는 싱글톤으로 관리
  - 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용
  - 모든 고객 요청은 동일한 서블릿 객체 인스턴스에 접근
  - __공유 변수를 사용할 때는 주의해야 한다__
  - 서블릿 컨테이너 종료시 함께 종료
- JSP도 서블릿으로 변환되어서 사용
- 동시 요청을 위한 멀티 쓰레드 처리 지원

## 동시 요청 - 멀티쓰레드

### 쓰레드
- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드이다
- 자바 메인 메소드를 처음 실행하면 main이라는 이름의 쓰레드가 실행된다
- 쓰레드는 한번에 하나의 코드 라인만 수행한다
- 동시처리가 필요하면 쓰레드를 추가로 생성한다

### 요청마다 쓰레드 생성
- 장점
  - 동시 요청을 처리할 수 있다
  - 리소스가 허용할 때까지 처리가 가능하다
  - 하나의 쓰레드가 지연되어도, 나머지 쓰레드는 정상 동작한다
- 단점
  - 쓰레드의 생성비용이 매우 비싸다
  - 컨텍스트 스위칭 비용이 발생한다
  - 생성에 제한이 없다 -> 고객 요청이 너무 많이 오면, 리소스의 제한으로 서버가 죽을 수 있다

위와 같은 단점을 해결하기 위해 __쓰레드 풀__ 을 사용한다

### 쓰레드 풀
- 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다
- 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다.(톰캣은 최대 200개 기본 설정이다)
- 쓰레드가 필요하면 풀에서 꺼내 사용하고, 끝나면 반납한다
- 풀에 쓰레드가 없으면 요청을 거절하거나, 특정 숫자만큼만 대기하도록 성정할 수 있다
- 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용이 절약되고, 응답시간이 빠르다
- 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다
<img width="1001" alt="스크린샷 2022-02-15 오후 9 48 12" src="https://user-images.githubusercontent.com/80378041/154065147-643e1906-f748-4e52-b4e3-8ea5a538de8c.png">

### 실무 팁!
- WAS의 주요 튜닝 포인트는 최대 쓰레드 수이다.
- 이 값이 너무 낮으면, 서버 리소스는 여유롭지만, 클라이언트는 금방 응답 지연에 빠진다
- 이 값이 너무 높으면, 서버 리소스 임계점 초과로 서버가 다운될 수 있다
- __성능 테스트를 통해 적정 숫자를 찾는 것이 중요하다__

